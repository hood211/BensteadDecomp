---
title: "01_GAMtest"
author: "JMH"
date: "10/26/2020"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
    number_sections: true  ## if you want number sections at each table header
    theme: cosmo  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
editor_options: 
  chunk_output_type: console
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(mgcv)
library(lme4)
library(ggpubr)
```

# Goal

Test the capability of GAM models to extract a known temperature dependency for decomposition buried in seasonal pattern in decomposition. We will create fake data with a known seasonality and temperature effect, build a GAM model similar in structure used in our manuscript, and evaluate whether or not the GAM can extract the correct seasonality and temperature dependency.

# Load temperature data

We'll build this up using the real temperature and decomposition data.

```{r}
decomp <- read.csv("01_combinedDataNew2.csv", row.names = 1) %>%  
  mutate(Pdt = as.POSIXct(collection.date, format = "%m/%d/%y"),
         monthN = month,
         monthN = fct_recode(monthN, "1" = "Jan",
                             "2" = "Feb",
                             "3" = "Mar",
                             "4" = "Apr",
                             "5" = "May",
                             "6" = "Jun",
                             "7" = "Jul",
                             "8" = "Aug",
                             "9" = "Sep",
                             "10" = "Oct",
                             "11" = "Nov",
                             "12" = "Dec"),
         monthN = as.numeric(as.character(monthN))) %>% 
  #Lick and Stamp have ≥ 1 positive decomposition rate in May and June, respectively
  filter(k < 0 & mesh2 == "fine") %>% 
  mutate(lnK = log(abs(k)),
         #Center temperature data
         ArrheniusC = Arrhenius - 1/((15 + 273.15)*0.0000862)) %>% 
  group_by(stream, mesh2, monthN) %>% 
  # removing one very low decomposition rate
  filter(lnK >-5) %>% 
  ungroup() %>% 
  select(stream, monthN, rep, ArrheniusC, Temp, lnK) %>% 
  droplevels() %>% 
  arrange(stream, rep, monthN)
```


Here's the variation in temperature as a function of month in each stream.

```{r echo=FALSE}
ggplot() +
  geom_line(data =decomp, aes(y = Temp, x = monthN, color = stream)) 
```

What is the correlation between temperature and month? 

```{r}
cor(decomp$Temp, decomp$monthN, method = "spearman")
```

The correlation is pretty low due to the non-linearity. During most months prior to September, we have > 5°C variation in temperature among streams.

# Generate fake data
Let's assume that k has two components: (1) a temperature dependency and (2) a seasonality which is everything else that influences k that varies with month (e.g., chl a, shredding macroinvertebrates, nutrients, ect.). Here's our approach for faking the k data with these components:


  - Create decomposition data with a temperature dependency similar to what we observed with the GAM models.
  - Create decomposition data with two seasonality responses for k: (1) similar to the observed temperature X month relationship, (2) a much more complicated seasonality pattern as a worst case scenario.
  
We'll create each of these subcomponents and then sum them to calculate $k_{tot}$.

```{r}
FakeK <- decomp %>% 
  # a column with some random variation
  mutate(ranNum = rnorm(dim(decomp)[1], mean = 0, sd = 0.02),
         # the temperature effect - this is the model from the most likely GAM
         TempEffect = (-4.35 + -0.08*ArrheniusC)+ranNum,
         # the seasonal effect 
         # Intercept adjusted to make range same as temp effect
         SeasEffect1 = ((-8.5 + 0.2*monthN + -0.015*monthN^2) +ranNum)*0.55, #0.55 to make range smaller
         SeasEffect2 = -4.25 + sin(monthN)*0.1 + ranNum,
         # add them together (intercept incorporated into temp effect)
         kTot1 = TempEffect + SeasEffect1,
         kTot2 = TempEffect + SeasEffect2) 
```

# Examine fake data

## Temperature
By design, there's the same temperature effect in both models: k = 0.08. Same as from our GAMS.
```{r  echo=FALSE}
ggplot() +
  geom_point(data = FakeK, aes(y = TempEffect, x = ArrheniusC)) +
  geom_abline(intercept = -4.35, slope = -0.08) + # model fit
  ylim(-4.6,-4.1)
```

## Seasonality

Seasonality of K versus temperature and month. This is $K_{tot}$.
```{r echo=FALSE, message=FALSE, warning=FALSE}
kTotMonthP <- ggplot(FakeK %>% 
         select(stream, monthN,ArrheniusC, kTot1, kTot2) %>% 
         pivot_longer(cols = kTot1:kTot2, names_to = "names", values_to = "kTot"),
       aes(y = kTot, x = monthN, color = names)) +
  geom_point()  +
  stat_smooth()

kTotTempP <- ggplot(FakeK %>% 
         select(stream, monthN,ArrheniusC, kTot1, kTot2) %>% 
         pivot_longer(cols = kTot1:kTot2, names_to = "names", values_to = "kTot"),
       aes(y = kTot, x = ArrheniusC, color = names)) +
  geom_point()  +
  stat_smooth(method = "lm")

ggarrange(kTotMonthP, kTotTempP, nrow = 1, ncol = 2)
```

## Related to real data?

```{r echo=FALSE}
ggplot(FakeK, aes(y = kTot1, x = lnK)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  ylim(-9.5,-3.5)
```


# Models

```{r include=FALSE}
#Bunch of junk to make the gam work
FakeK$group <- "NA"
spring <- c("ami", "schultz")
may <- c("hendrick", "town")
june <- c("coon", "choco", "stamp")
july <- c("lick", "mayfield")
FakeK$group <- as.factor(as.character(ifelse(FakeK$stream %in% spring, "spring", 
                                              ifelse(FakeK$stream %in% may, "may",
                                                     ifelse(FakeK$stream %in%  june, "june",
                                                            ifelse(FakeK$stream %in%  july, "july", "NA"))))))
FakeK$Only2Groups <- "NA"
FakeK$Only2Groups <- as.factor(as.character(ifelse(FakeK$group == "july" | FakeK$group == "june", "Summer", "Spring")))

cor1a <- corARMA(p = 1, q = 0, form = ~ monthN | stream / rep) # 1 time step, 1 smoothing

FakeK$stream <- as.factor(FakeK$stream)
```


## Seasonality 1
### GAM
Best fine-mesh gam model - it works! The GAM returns an AE close to what we put in and a seasonality similar to what we created.
```{r}
Bgam1 <- gamm(kTot1 ~ ArrheniusC + s(monthN, by = Only2Groups, bs = "cc", k = 12)+ s(stream, bs="re"), 
                      correlation = cor1a, data = FakeK)
```

```{r}
summary(Bgam1$gam)
```


```{r echo=FALSE}
plot(Bgam1$gam, pages =1)
```
### LME
Linear mixed effects model - Hah! it works!!!!
```{r}
Blme1 <- lme(kTot1 ~ ArrheniusC, random = ~1|stream, data = FakeK)
```

```{r}
summary(Blme1)
```

## Seasonality 2

### GAM

This gives us a slightly lower estimate of AE that we put in: -0.08 v. -0.047
```{r}
Bgam2 <- gamm(kTot2 ~ ArrheniusC + s(monthN, by = Only2Groups, bs = "cc", k = 12)+ s(stream, bs="re"), 
                      correlation = cor1a, data = FakeK)
```

```{r}
summary(Bgam2$gam)
```


```{r echo=FALSE}
plot(Bgam2$gam, pages =1)
```

### LME
In this case, the lme model gets us closer to the TRUE AE eventhough it doesn't account for the seasonality.
```{r}
Blme2 <- lme(kTot2 ~ ArrheniusC, random = ~1|stream, data = FakeK)
```

```{r}
summary(Blme2)
```
